name: Check Website Status

on:
  workflow_dispatch:
    inputs:
      url:
        description: '监控的网址'
        required: true
      access_token:
        description: '钉钉机器人的 Access Token'
        required: true

jobs:
  check-status:
    runs-on: ubuntu-latest
    steps:
      - name: Install Lynx
        run: |
          sudo apt-get update
          sudo apt-get install -y lynx

      - name: Fetch Website Status
        id: fetch_status
        run: |
          # 获取状态码
          response=$(curl -Ls -o /dev/null -w "%{http_code}" "${{ github.event.inputs.url }}")
          status_code="$response"
          
          # 获取网页内容并提取有效文本
          content=$(lynx -dump "${{ github.event.inputs.url }}")
          
          # 截取前200个字符
          summary=$(echo "$content" | awk '{print substr($0,1,200)}')
          echo "::set-output name=status_code::$status_code"
          echo "::set-output name=summary::$summary"

      - name: Send to DingTalk
        run: |
          status_code="${{ steps.fetch_status.outputs.status_code }}"
          summary="${{ steps.fetch_status.outputs.summary }}"
          webhook_url="https://oapi.dingtalk.com/robot/send?access_token=${{ github.event.inputs.access_token }}"
          title="网页监控"

          if [[ "$status_code" == "302" ]]; then
            summary="警告：返回状态码 302; 可能存在重定向; 内容摘要：$summary"
          elif [[ "$status_code" != "200" && "$status_code" != "301" ]]; then
            summary="错误：返回状态码 $status_code; 内容摘要：$summary"
          else
            summary="状态码：$status_code; 内容摘要：$summary"
          fi

          curl -X POST "$webhook_url" \
            -H 'Content-Type: application/json' \
            -d "{\"msgtype\": \"markdown\", \"markdown\": {\"title\": \"$title\", \"text\": \"$summary\"}}"
